"use strict";(self.webpackChunkdhenara_docs=self.webpackChunkdhenara_docs||[]).push([[4808],{1768:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>c,frontMatter:()=>r,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"dhenara-agent/guides/tutorials/command-line-coder/part-2","title":"Part 2: Planning Flow","description":"In the previous part, we built a simple single-shot coding assistant that could implement straightforward tasks in one","source":"@site/docs/dhenara-agent/guides/tutorials/command-line-coder/part-2.md","sourceDirName":"dhenara-agent/guides/tutorials/command-line-coder","slug":"/dhenara-agent/guides/tutorials/command-line-coder/part-2","permalink":"/dhenara-agent/guides/tutorials/command-line-coder/part-2","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3}}');var a=t(4848),o=t(8453);const r={sidebar_position:3},s="Part 2: Planning Flow",l={},d=[{value:"Why Add Planning?",id:"why-add-planning",level:2},{value:"Creating a New Agent",id:"creating-a-new-agent",level:2},{value:"Understanding the Plan Structure",id:"understanding-the-plan-structure",level:2},{value:"Creating the Planner Flow",id:"creating-the-planner-flow",level:2},{value:"Implementing the Handler",id:"implementing-the-handler",level:2},{value:"Setting Up the Agent",id:"setting-up-the-agent",level:2},{value:"Testing the Planner",id:"testing-the-planner",level:2},{value:"Examining the Results",id:"examining-the-results",level:2},{value:"What&#39;s Next?",id:"whats-next",level:2}];function p(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"part-2-planning-flow",children:"Part 2: Planning Flow"})}),"\n",(0,a.jsx)(n.p,{children:"In the previous part, we built a simple single-shot coding assistant that could implement straightforward tasks in one\ngo. However, for more complex tasks, it's helpful to first create a plan that breaks the task down into manageable\nsteps."}),"\n",(0,a.jsx)(n.p,{children:"In this part, we'll add a planning flow to our coding assistant that will:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Analyze the codebase to understand the context"}),"\n",(0,a.jsx)(n.li,{children:"Create a structured plan with multiple implementation steps"}),"\n",(0,a.jsx)(n.li,{children:"Prepare the groundwork for executing those steps sequentially"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"why-add-planning",children:"Why Add Planning?"}),"\n",(0,a.jsx)(n.p,{children:"Planning offers several advantages for a coding assistant:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Better context management"}),": Breaking tasks into smaller pieces helps manage the context window limitations of LLMs"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Improved structured reasoning"}),": Planning first encourages the model to think through the problem before coding"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Progress tracking"}),": A plan allows tracking progress through complex tasks"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Error isolation"}),": If one step fails, others can still succeed"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"creating-a-new-agent",children:"Creating a New Agent"}),"\n",(0,a.jsx)(n.p,{children:"Let's create a new agent that builds on our single-shot implementation but adds planning capabilities:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"dad agent create planner_coder\n"})}),"\n",(0,a.jsx)(n.h2,{id:"understanding-the-plan-structure",children:"Understanding the Plan Structure"}),"\n",(0,a.jsxs)(n.p,{children:["First, let's define the structure for our plan in a ",(0,a.jsx)(n.code,{children:"types.py"})," file:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# src/agents/planner_coder/types.py\nfrom dhenara.agent.dsl.inbuilt.flow_nodes.defs.types import (\n    FileOperation,\n    FileSystemAnalysisOperation,\n    FolderAnalysisOperation,\n)\nfrom pydantic import BaseModel, Field\n\n\nclass TaskSpec(BaseModel):\n    """\n    Specification for a logical development task with its required context.\n    Each task is a discrete unit of work in the overall plan.\n    """\n\n    order: int = Field(\n        ...,\n        description="Execution order of this task in the overall plan",\n    )\n    task_id: str = Field(\n        ...,\n        description="Unique identifier for this task using only lowercase letters, numbers, and underscores [a-z0-9_]",\n        pattern="^[a-z0-9_]+$",\n    )\n    description: str = Field(\n        ...,\n        description="Precise and detailed description of what this task accomplishes in markdown format",\n    )\n    required_context: list[FolderAnalysisOperation] = Field(\n        default_factory=list,\n        description="List of specific file-system analysis operations needed to provide context for implementing this task",\n    )\n\n\nclass Plan(BaseModel):\n    """\n    A comprehensive, structured plan for implementing a specific task given by the user.\n    Outlines the entire implementation strategy broken down into logical tasks.\n    """\n\n    title: str = Field(\n        ...,\n        description="Concise title of the plan under 100 characters",\n    )\n    description: str = Field(\n        ...,\n        description="Detailed explanation of the implementation approach in markdown format",\n    )\n    implementation_tasks: list[TaskSpec] = Field(\n        ...,\n        description="Ordered tasks of implementation, each representing a logical step in the overall plan",\n    )\n    validation_steps: list[str] = Field(\n        ...,\n        description="Steps to validate that the complete implementation works correctly",\n    )\n    estimated_complexity: int | None = Field(\n        None,\n        description="Optional estimate of implementation complexity on a scale of 1-10",\n        ge=1,\n        le=10\n    )\n\n    def get_task_by_id(self, task_id: str) -> TaskSpec | None:\n        """Retrieve a specific implementation task by its ID"""\n        for task in self.implementation_tasks:\n            if task.task_id == task_id:\n                return task\n        return None\n\n\nclass TaskImplementation(BaseModel):\n    """\n    Contains the concrete file operations to implement a specific task of the plan.\n    This is the output generated after analyzing the context specified in the TaskSpec.\n    """\n\n    task_id: str | None = Field(\n        default=None,\n        description="ID of the corresponding TaskSpec that this implements",\n    )\n    file_operations: list[FileOperation] | None = Field(\n        default_factory=list,\n        description="Ordered list of file operations to execute for this implementation task",\n    )\n    execution_commands: list[dict] | None = Field(\n        None,\n        description="Optional shell commands to run after file operations (e.g., for build or setup)",\n    )\n    verification_commands: list[dict] | None = Field(\n        None,\n        description="Optional commands to verify the changes work as expected",\n    )\n'})}),"\n",(0,a.jsx)(n.h2,{id:"creating-the-planner-flow",children:"Creating the Planner Flow"}),"\n",(0,a.jsxs)(n.p,{children:["Now, let's create a planner flow in a new file called ",(0,a.jsx)(n.code,{children:"planner.py"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# src/agents/planner_coder/flows/planner.py\nfrom dhenara.agent.dsl import (\n    AIModelNode,\n    AIModelNodeSettings,\n    EventType,\n    FlowDefinition,\n    FolderAnalyzerNode,\n    FolderAnalyzerSettings,\n)\nfrom dhenara.agent.dsl.inbuilt.flow_nodes.defs.types import FolderAnalysisOperation\nfrom dhenara.ai.types import (\n    AIModelCallConfig,\n    ObjectTemplate,\n    Prompt,\n)\n\nfrom ..types import Plan\n\n# Constants\nglobal_data_directory = "$expr{run_root}/global_data"\nmodels = [\n    "claude-3-7-sonnet",\n    "gpt-4.1",\n    "gpt-4.1-mini",\n    "claude-3-5-haiku",\n]\ntest_mode = False\n\n# Create the planner flow\nplanner_flow = FlowDefinition().vars(\n    {\n        "task_description": "Create a simple web server in Python using Flask that serves a RESTful API with endpoints for creating, reading, updating, and deleting user records stored in a SQLite database.",\n    }\n)\n\n# 1. Initial Folder Analysis for Context\nplanner_flow.node(\n    "repo_analysis",\n    FolderAnalyzerNode(\n        pre_events=[EventType.node_input_required],  # This will trigger our input handler\n        settings=FolderAnalyzerSettings(\n            base_directory=global_data_directory,\n            operations=[\n                FolderAnalysisOperation(\n                    operation_type="analyze_folder",\n                    path=".",  # Analyze the current directory\n                    max_depth=3,\n                    include_primary_meta=True,\n                    respect_gitignore=True,\n                    content_read_mode="structure",\n                    max_words_per_file=None,\n                ),\n            ],\n        ),\n    ),\n)\n\n# 2. Planning Node\nplanner_flow.node(\n    "plan_generator",\n    AIModelNode(\n        pre_events=[EventType.node_input_required],\n        settings=AIModelNodeSettings(\n            models=models,\n            system_instructions=[\n                "You are a professional implementation planner for coding tasks.",\n                "Your job is to create a detailed implementation plan based on the task requirements and folder analysis.",\n                "Break down complex tasks into logical steps that can be implemented independently.",\n                "For each step, specify which files need to be analyzed to provide context.",\n                "Optimize for implementation with LLM context window limitations.",\n                "Return a structured Plan object for downstream processing.",\n            ],\n            prompt=Prompt.with_dad_text(\n                text=(\n                    "## Task Description\\n"\n                    "$var{task_description}\\n\\n"\n                    "## Repository Context\\n"\n                    "$expr{$hier{repo_analysis}.outcome.results}\\n\\n"\n                    "Generate a detailed implementation plan. You must return a Plan object with the following:\\n"\n                    "1. A concise title for the plan\\n"\n                    "2. A detailed description of the implementation approach\\n"\n                    "3. An ordered list of implementation tasks, each with:\\n"\n                    "   - A unique task_id\\n"\n                    "   - An execution order number\\n"\n                    "   - A detailed description\\n"\n                    "   - Required context (specific files/folders to analyze)\\n"\n                    "4. Validation steps to verify the implementation\\n"\n                    "5. An estimated complexity rating (1-10)\\n\\n"\n                    "Optimize for context window limitations by keeping each task focused and manageable.\\n"\n                ),\n            ),\n            model_call_config=AIModelCallConfig(\n                structured_output=Plan,\n                test_mode=test_mode,\n            ),\n        ),\n    ),\n)\n'})}),"\n",(0,a.jsx)(n.h2,{id:"implementing-the-handler",children:"Implementing the Handler"}),"\n",(0,a.jsx)(n.p,{children:"Let's update our handler to support the planning flow:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# src/agents/planner_coder/handler.py\nfrom dhenara.agent.dsl import (\n    FlowNodeTypeEnum,\n    NodeInputRequiredEvent,\n)\nfrom dhenara.agent.utils.helpers.terminal import (\n    async_input,\n    get_ai_model_node_input,\n    get_folder_analyzer_node_input,\n)\n\n# Global constants (you might want to move these to a defs.py file)\nglobal_data_directory = "$expr{run_root}/global_data"\nmodels = [\n    "claude-3-7-sonnet",\n    "gpt-4o",\n    "gpt-4.1",\n    "claude-3-opus",\n    "gpt-4o-mini",\n    "claude-3-5-haiku",\n]\n\n\nasync def planner_coder_input_handler(event: NodeInputRequiredEvent):\n    """Handles input required events for the planner coder"""\n    if event.node_type == FlowNodeTypeEnum.ai_model_call:\n        node_input = None\n\n        if event.node_id == "plan_generator":\n            node_input = await get_ai_model_node_input(\n                node_def_settings=event.node_def_settings,\n                models=models,\n            )\n\n            # Get the task description from the user\n            task_description = await async_input("Please enter your coding task: ")\n            node_input.prompt_variables = {"task_description": task_description}\n\n        else:\n            print(f"WARNING: Unhandled ai_model_call input event for node {event.node_id}")\n\n        event.input = node_input\n        event.handled = True\n\n    elif event.node_type == FlowNodeTypeEnum.folder_analyzer:\n        if event.node_id == "repo_analysis":\n            node_input = await get_folder_analyzer_node_input(\n                node_def_settings=event.node_def_settings,\n                base_directory=global_data_directory,\n            )\n        else:\n            print(f"WARNING: Unhandled folder_analyzer input event for node {event.node_id}")\n\n        event.input = node_input\n        event.handled = True\n'})}),"\n",(0,a.jsx)(n.h2,{id:"setting-up-the-agent",children:"Setting Up the Agent"}),"\n",(0,a.jsx)(n.p,{children:"With our planner flow defined, let's update the agent.py file:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'# src/agents/planner_coder/agent.py\nfrom dhenara.agent.dsl import AgentDefinition\n\nfrom .flows.planner import planner_flow\n\n# Main Agent Definition\nagent = AgentDefinition()\nagent.flow(\n    "planner",\n    planner_flow,\n)\n'})}),"\n",(0,a.jsx)(n.h2,{id:"testing-the-planner",children:"Testing the Planner"}),"\n",(0,a.jsx)(n.p,{children:"Now you can run your planner agent:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"dad agent run planner_coder\n"})}),"\n",(0,a.jsx)(n.p,{children:"When you run this, you'll be prompted for a task description. The agent will then analyze the codebase and generate a\nstructured plan with steps for implementation."}),"\n",(0,a.jsx)(n.h2,{id:"examining-the-results",children:"Examining the Results"}),"\n",(0,a.jsx)(n.p,{children:"After running the agent, you can examine the generated plan in the outcome.json file in the run directory. The plan will\ninclude:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"A title and description of the implementation approach"}),"\n",(0,a.jsx)(n.li,{children:"A list of ordered tasks with unique IDs"}),"\n",(0,a.jsx)(n.li,{children:"For each task, a detailed description and required context"}),"\n",(0,a.jsx)(n.li,{children:"Validation steps to verify the implementation"}),"\n",(0,a.jsx)(n.li,{children:"An estimated complexity rating"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"whats-next",children:"What's Next?"}),"\n",(0,a.jsx)(n.p,{children:"Now that we have a planning flow that can break down complex tasks into manageable steps, we need to enhance our\nimplementation flow to:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Accept a task from the plan"}),"\n",(0,a.jsx)(n.li,{children:"Analyze the required context"}),"\n",(0,a.jsx)(n.li,{children:"Implement the specific task"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["In ",(0,a.jsx)(n.a,{href:"/dhenara-agent/guides/tutorials/command-line-coder/part-3",children:"Part 3: Enhanced Implementation Flow"}),", we'll update our implementation flow to handle these\nrequirements and work with the output from our planner."]})]})}function c(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(p,{...e})}):p(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>s});var i=t(6540);const a={},o=i.createContext(a);function r(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);